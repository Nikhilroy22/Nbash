name: Build OpenJDK 17 Zero for Android ARMv7

on: [push, workflow_dispatch]

jobs:
  build-openjdk:
    runs-on: ubuntu-latest

    env:
      NDK: ${{ github.workspace }}/ndk
      TOOLCHAIN: ${{ github.workspace }}/ndk/toolchains/llvm/prebuilt/linux-x86_64
      CC: ${{ github.workspace }}/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
      CXX: ${{ github.workspace }}/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Required Packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential autoconf zip unzip curl \
          file libx11-dev libxext-dev libxrender-dev \
          libxtst-dev libxt-dev libcups2-dev libasound2-dev \
          libfreetype6-dev libxrandr-dev

    - name: Download Android NDK r25c
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        mv android-ndk-r25c ndk

    - name: Download JDK 17 (Boot JDK)
      run: |
        wget https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.10%2B7/OpenJDK17U-jdk_x64_linux_hotspot_17.0.10_7.tar.gz
        tar -xf OpenJDK17U-jdk_x64_linux_hotspot_17.0.10_7.tar.gz
        mv jdk-17.0.10+7 bootjdk

    - name: Clone OpenJDK 17 Source
      run: |
        git clone https://github.com/openjdk/jdk17u.git

    - name: Fix config.sub for Android
      run: |
        cd jdk17u
        wget https://git.savannah.gnu.org/cgit/config.git/plain/config.sub \
          -O ./make/autoconf/build-aux/config.sub

    - name: Configure OpenJDK for Android ARMv7
      run: |
        cd jdk17u

        # Append TOOLCHAIN to PATH
        export PATH="$TOOLCHAIN/bin:$PATH"

        echo ">>> Checking compiler"
        echo "CC=$CC"
        echo "CXX=$CXX"
        $CC --version

        bash configure \
          --openjdk-target=arm-linux-androideabi \
          --with-toolchain-type=clang \
          --with-boot-jdk=$GITHUB_WORKSPACE/bootjdk \
          --with-jvm-variants=zero \
          --with-debug-level=release \
          --disable-warnings-as-errors \
          --enable-headless-only \
          --with-tools-dir=$TOOLCHAIN/bin

    - name: Build OpenJDK
      run: |
        cd jdk17u
        make images

    - name: Upload OpenJDK ARMv7 Build
      uses: actions/upload-artifact@v4
      with:
        name: openjdk-17-zero-android-armv7
        path: jdk17u/build/linux-arm-normal-zero-release/images