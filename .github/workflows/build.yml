name: Build PHP for ARMv7

on:
  workflow_dispatch:
  push:
    branches: [ main ]  # ম্যানুয়ালি ও main ব্রাঞ্চে push দিলে চলবে

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build PHP for ARMv7

    steps:
      - name: কোড ক্লোন করুন
        uses: actions/checkout@v4

      - name: প্রয়োজনীয় প্যাকেজ ইনস্টল করুন
        run: |
          sudo apt update
          sudo apt install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
              make autoconf bison re2c libxml2-dev \
              libncurses5-dev libncursesw5-dev curl \
              perl build-essential

      - name: OpenSSL সোর্স কোড ডাউনলোড ও Build (armv7)
        run: |
          curl -LO https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          tar -xf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w

          export CROSS_COMPILE=arm-linux-gnueabihf-
          export CC=arm-linux-gnueabihf-gcc

          ./Configure linux-armv4 \
              --prefix=$GITHUB_WORKSPACE/openssl-armv7 \
              no-shared no-async no-tests \
              --cross-compile-prefix=arm-linux-gnueabihf-

          make -j$(nproc)
          make install_sw

      - name: PHP সোর্স কোড ডাউনলোড করুন
        run: |
          curl -O https://www.php.net/distributions/php-8.2.21.tar.gz
          tar -xzf php-8.2.21.tar.gz

      - name: কনফিগার ও কম্পাইল PHP with custom OpenSSL
        run: |
          cd php-8.2.21
          ./configure \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --disable-all \
            --enable-cli \
            --with-openssl=$GITHUB_WORKSPACE/openssl-armv7 \
            --with-openssl-dir=$GITHUB_WORKSPACE/openssl-armv7 \
            CC=arm-linux-gnueabihf-gcc \
            CXX=arm-linux-gnueabihf-g++ \
            --prefix=$PWD/build-armv7

          make -j$(nproc)
          make install

      - name: Output ফাইল আর্কাইভ করুন
        run: |
          cd php-8.2.21
          tar -czvf php-armv7.tar.gz build-armv7

      - name: Build Result সংরক্ষণ করুন
        uses: actions/upload-artifact@v4
        with:
          name: php-armv7
          path: php-8.2.21/php-armv7.tar.gz