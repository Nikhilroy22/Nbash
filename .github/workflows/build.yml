name: Build Bash 5.3 for Android ARMv7

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Bash 5.3 ARMv7 with Dependencies

    steps:
      - name: কোড ক্লোন করুন
        uses: actions/checkout@v4

      - name: প্রয়োজনীয় টুলস ইনস্টল করুন
        run: |
          sudo apt update
          sudo apt install -y wget build-essential autoconf \
            automake libtool texinfo bison flex \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            qemu-user file

      - name: Bash 5.3 সোর্স ডাউনলোড ও এক্সট্রাক্ট করুন
        run: |
          wget https://mirrors.kernel.org/gnu/bash/bash-5.3.tar.gz
          tar -xf bash-5.3.tar.gz
          mv bash-5.3 bash

      - name: Bash Configure ও Build করুন
        run: |
          cd bash
          ./configure --host=arm-linux-gnueabihf \
                      --prefix=$PWD/build-armv7 \
                      --without-bash-malloc
          make -j$(nproc)
          make install

      - name: ডিপেন্ডেন্সি লাইব্রেরিগুলো সংগ্রহ করুন
        run: |
          mkdir -p deps
          cd bash/build-armv7/bin

          # detect runtime .so dependencies using `readelf`
          arm-linux-gnueabihf-readelf -d bash | grep NEEDED || true

          # copy common dependencies manually
          cp /usr/arm-linux-gnueabihf/lib/*tinfo*.so* ../../../../deps/ || true
          cp /usr/arm-linux-gnueabihf/lib/*readline*.so* ../../../../deps/ || true
          cp /usr/arm-linux-gnueabihf/lib/*ncurses*.so* ../../../../deps/ || true

      - name: আর্কাইভ তৈরি করুন
        run: |
          mkdir -p output/bin output/lib
          cp bash/build-armv7/bin/bash output/bin/
          cp deps/*.so* output/lib/ || true

          cd output
          tar -czvf $GITHUB_WORKSPACE/bash-5.3-armv7-with-deps.tar.gz .

      - name: Artifact আপলোড করুন
        uses: actions/upload-artifact@v4
        with:
          name: bash-5.3-armv7-with-deps
          path: bash-5.3-armv7-with-deps.tar.gz