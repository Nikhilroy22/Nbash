name: Build Bash for Android ARMv7

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Bash ARMv7 with Dependencies

    steps:
      - name: কোড ক্লোন করুন
        uses: actions/checkout@v4

      - name: প্রয়োজনীয় টুলস ইনস্টল করুন
        run: |
          sudo apt update
          sudo apt install -y wget build-essential autoconf \
            automake libtool git texinfo bison flex \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            qemu-user

      - name: Bash সোর্স ক্লোন করুন
        run: |
          git clone https://git.savannah.gnu.org/git/bash.git
          cd bash
          git checkout bash-5.1

      - name: Configure ও Build করুন
        run: |
          cd bash

          # স্ট্যাটিক না করে ডিপেন্ডেন্সি .so ফাইলগুলো track করবো
          ./configure --host=arm-linux-gnueabihf \
                      --prefix=$PWD/build-armv7 \
                      --without-bash-malloc

          make -j$(nproc)
          make install

      - name: রানটাইম `.so` ডিপেন্ডেন্সি খুঁজে বের করুন
        run: |
          cd bash/build-armv7/bin
          arm-linux-gnueabihf-readelf -d bash | grep NEEDED || true

          mkdir -p deps

          # নিদিষ্ট কিছু common lib copy করুন (optional, expand if needed)
          cp /usr/arm-linux-gnueabihf/lib/*tinfo*.so* deps/ || true
          cp /usr/arm-linux-gnueabihf/lib/*readline*.so* deps/ || true
          cp /usr/arm-linux-gnueabihf/lib/*ncurses*.so* deps/ || true

      - name: আর্কাইভ বানান (bash + deps)
        run: |
          cd bash/build-armv7
          mkdir -p bundle/bin bundle/lib
          cp bin/bash bundle/bin/

          # deps ফোল্ডার থেকে লাইব্রেরিগুলো কপি করুন (from earlier step)
          cp ../../deps/*.so* bundle/lib/ || true

          cd bundle
          tar -czvf ../../bash-armv7-with-deps.tar.gz .

      - name: Artifact আপলোড করুন
        uses: actions/upload-artifact@v4
        with:
          name: bash-armv7-with-deps
          path: bash-armv7-with-deps.tar.gz