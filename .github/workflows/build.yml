name: Build PHP for Android ARMv7

on: [push, workflow_dispatch]

jobs:
  build-php:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install Build Tools
      run: |
        sudo apt update
        sudo apt install -y \
          autoconf bison re2c libxml2-dev \
          curl unzip wget build-essential pkg-config

    - name: Download Android NDK r25c
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        mv android-ndk-r25c ndk

    - name: Clone PHP Source
      run: |
        git clone --depth=1 https://github.com/php/php-src.git -b PHP-8.2 php-src

    - name: Configure and Build PHP for Android
      run: |
        export NDK=$GITHUB_WORKSPACE/ndk
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export API=21
        export TARGET=armv7a-linux-androideabi
        export SYSROOT=$TOOLCHAIN/sysroot

        export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
        export CXX=$TOOLCHAIN/bin/${TARGET}${API}-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRIP=$TOOLCHAIN/bin/llvm-strip

        cd php-src

        ./buildconf --force

        ./configure \
          --host=$TARGET \
          --target=$TARGET \
          --build=x86_64-pc-linux-gnu \
          --prefix=$GITHUB_WORKSPACE/php-android \
          --disable-all \
          --enable-cli \
          --without-pear \
          CC=$CC \
          CXX=$CXX \
          AR=$AR \
          RANLIB=$RANLIB \
          STRIP=$STRIP \
          --with-sysroot=$SYSROOT

        make -j$(nproc)
        make install

    - name: Upload PHP Binary
      uses: actions/upload-artifact@v4
      with:
        name: php-android-cli-armv7
        path: php-android/bin/php